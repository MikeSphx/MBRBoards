<!-- Load the Polymer.Element base class -->
<!-- <link rel="import" href="./bower_components/polymer/polymer-element.html"> -->

<dom-module id="leaderboard-page">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment">

      :host {
        display: block;
        position: relative;
        overflow: hidden;
      }

      a[disabled] {
        color: #9E9E9E !important;
        pointer-events: none;
        cursor: default;
      }

      #container {
        width: 60%;
        height: 100%;
        /*background-color: blue;*/
      }
      #main {
        height: 1500px;
        /*background-color: red;*/
      }
      #top {
        height: 130px;
      }
      #topMenu {
        color: #E53935;
        margin: 0px 0px 10px 0px;
        font-size: 17px;
        font-weight: bold;
      }
      #topLeftTitle {
        margin: 0px 0px 2px 0px;
        color: #E53935;
        font-size: 35px;
        font-weight: bold;
        /*margin: 0px 0px 10px 0px;*/
      }
      #topLeftMenu {
        color: #E53935;
        margin: 0px 0px 15px 0px;
        font-size: 17px;
        font-weight: bold;
      }
      #topLeftMenu a {
        color: #E53935;
        font-weight: normal;
        font-style: italic;
      }
      .redText: {
        color: #E53935;
      }
      .leaderboardCard {
        margin: 5px 0px 5px 0px;
      }
      .playerCardPic {
        height: 80px;
        width: 80px;
        margin: 0px 15px 0px 0px;
      }
      .fullWidth {
        width: 100%;
      }
      .sortButton {
        padding: 0px 0px 0px 0px;
        text-transform: capitalize;
      }

    </style>

    <app-location route="{{route}}"></app-location>
    <app-route id="appRoute"
    route="{{route}}"
    pattern="/leaderboard/:sort/:page"
    data="{{routeData}}"
    tail="{{subroute}}"></app-route>
    <app-route id="appRoute"
    route="{{route}}"
    pattern="/leaderboard/:sort/:page/:search"
    data="{{routeData}}"
    tail="{{subroute}}"></app-route>

    <div id="main" class=".fullWidth horizontal center-justified layout">
      <div id="container" class="vertical layout">
        <div id="top" class="horizontal layout end">
          <div id="topLeft" class="vertical layout">
            <div id="topLeftTitle">[ MBR Leaderboard ]</div>
            <div id="topLeftMenu">Sort by:
              <paper-button id="apSort" class="sortButton" on-click="_changeSort" sort="ap" raised style="min-width: 40px" disabled>AP</paper-button>
              <paper-button id="winSort" class="sortButton" on-tap="_changeSort" sort="win" raised style="min-width: 60px">Wins</paper-button>
              <paper-button id="mesoSort" class="sortButton" on-tap="_changeSort" sort="meso" raised style="min-width: 70px">Mesos</paper-button>
            </div>
          </div>
          <div class="flex"></div>
          <div id="topMenu"></div>
        </div>

        <dom-if>
        <template is='dom-repeat' items='[[mbrUsers]]' as="item">
          <div>
            <paper-card class="leaderboardCard fullWidth">
              <div class='card-content horizontal layout center'>
                <div class="playerCardPic vertical center-justified layout center">
                  <iron-image src=[[item.pic_link]]></iron-image>
                </div>
                <div class="flex"><b>[[item.name]]</b><br><b>Faction: </b> [[_emptyBind(item.faction)]]<br><b>Rank: </b> [[_calculateRank(index)]]</div>
                <div class="flex"><b>AP:</b> [[item.base_ap]] - [[_calculateClass(item.base_ap)]] Class<br><b>Record: </b> <span>[[item.record.win]]W</span>/<span>[[item.record.lose]]L</span>/<span>[[item.record.tie]]T</span><br><b>Mesos:</b> [[item.meso]]</div>
                <paper-icon-button icon="social:person" class="playCardProfile relative self-end" style="top: 10px; left:5px"></paper-icon-button>
              </div>  
            </paper-card>

          </div>
        </template>
        </dom-if>
      </div>
    </div>

    <iron-ajax
      id = "retrieveMbrUsers"
      url = "http://localhost:3000/api/mbr_users/leaderboard?sort=ap&"
      handle-as = "json"
      on-response = "_handleMbrUsers">
    </iron-ajax>
  </template>

  <script>
    class LeaderboardPage extends Polymer.Element {

      static get is() { return 'leaderboard-page'; }

      // Declare properties for the element's public API
      static get properties() {
        return {
          mbrUsers: {
            type: Array
          },
          currentPage: {
            type: Number,
            value: 1
          },
          test: {
            type: String,
            value: 'disabled'
          },
          oldRouteData: {
            type: Object
          }
        }
      }

      static get observers() {
        return [
          '_sortChangeHandler(routeData.sort)'
        ]
      }

      connectedCallback() {
        super.connectedCallback();

        // TODO Known bug where routeData.page listener fires twice (https://github.com/PolymerElements/app-route/issues/129)
        if (this.routeData != this.oldRouteData) {
          this._updateRequest();
          this.$.retrieveMbrUsers.generateRequest();
        }
      }

      resetLeaderboard() {
        this.$.apSort.setAttribute('disabled', '');
        this.$.winSort.removeAttribute('disabled');
        this.$.mesoSort.removeAttribute('disabled');

        this.$.retrieveMbrUsers.url = "http://localhost:3000/api/mbr_users/leaderboard";
        this.$.retrieveMbrUsers.generateRequest();
        console.log('leaderboard reset');
      }

      // Request handlers
      _handleMbrUsers(data) {
        this.mbrUsers = data.detail.response.docs;
      }

      // Helper functions
      _emptyBind(str) {
        return str ? str : 'None';
      }
      _calculateRank(num) {
        return ((this.currentPage - 1) * 10) + num + 1;
      }
      _calculateClass(num) {
        if (num > 500) {
          return 'S'; 
        } else {
          return 'C';
        }
      }
      _changeSort(e) {
        //console.log(e.target.getAttribute('sort'));
        if (typeof this.routeData.page != 'undefined') {
          this.set('routeData.sort', e.target.getAttribute('sort'));
        } else {
          var sort = e.target.getAttribute('sort');
          this.set('route.path', '/leaderboard/'+sort+'/1');
        }
      }
      _sortChangeHandler(sort) {
        // TODO Known bug where routeData.page listener fires twice (https://github.com/PolymerElements/app-route/issues/129)
        if (this.routeData != this.oldRouteData && typeof sort != 'undefined') {
          this.oldRouteData = this.routeData;
          if (sort == 'ap') {
            this.$.apSort.setAttribute('disabled', '');
            this.$.winSort.removeAttribute('disabled');
            this.$.mesoSort.removeAttribute('disabled');
          } else if (sort == 'win') {
            this.$.winSort.setAttribute('disabled', '');
            this.$.apSort.removeAttribute('disabled');
            this.$.mesoSort.removeAttribute('disabled');
          } else if (sort == 'meso') {
            this.$.mesoSort.setAttribute('disabled', '');
            this.$.apSort.removeAttribute('disabled');
            this.$.winSort.removeAttribute('disabled');
          }
          this._updateRequest();
          this.$.retrieveMbrUsers.generateRequest();
        }
      }
      _updateRequest() {
        //TODO could be sending user input into GET query?
        var sort = (typeof this.routeData.sort == 'undefined') ? '' : ('sort='+this.routeData.sort+'&');
        var page = (typeof this.routeData.page == 'undefined') ? '' : ('page='+this.routeData.page+'&');
        var search = (typeof this.routeData.search == 'undefined') ? '' : ('search='+this.routeData.search);
        var newUrl = "http://localhost:3000/api/mbr_users/leaderboard?"+sort+page+search;
        this.$.retrieveMbrUsers.url = newUrl;
        console.log('request updated: ' + newUrl);
      }
    }

    // Register the x-custom element with the browser
    customElements.define(LeaderboardPage.is, LeaderboardPage);
  </script>

</dom-module>